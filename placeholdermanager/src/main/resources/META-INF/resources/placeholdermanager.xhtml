<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
		"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	  xmlns:h="http://java.sun.com/jsf/html"
	  xmlns:p="http://primefaces.org/ui"
	  xmlns:ui="http://java.sun.com/jsf/facelets"
	  xmlns:f="http://java.sun.com/jsf/core"
>

<h:head>
</h:head>

<h:body style="margin-left:50px">
	
	
	<script type="text/javascript">
		function handleDrop(event, ui) {
			var droppredKey = ui.draggable;
			
		}
	</script>
    
	<p:panel id="panelApp">
		<f:facet name="header">
			<h:panelGrid columns="3">
				<p:graphicImage name="LOGO_ITS4U_Group_Interstate_COLOR.png"  style="background: transparent;width:200px;margin-right:20px;"/>
				
				<p:outputLabel value="OCP - GitOps Application Deployer"   style="width:100%;text-align: center;font-size: 40px;color:#003b50"></p:outputLabel>
				
			</h:panelGrid>			
		</f:facet>
   		<h:form id="form" prependId="false">
   		<p:growl id="growl" showDetail="true" />
   		
   		<p:dataTable value="#{placeHoldersView.projectList}"  var="proj"  widgetVar="projectsTable" id="projectstable">
   			<p:column  headerText="Project">	
				<h:outputText value="#{proj.project_Id}"/>
			</p:column>
   		</p:dataTable>
   		
   		<div style="position:relative;margin:auto;text-align:center;">	
	   		<p:commandButton value="Refresh"  actionListener="#{placeHoldersView.refresh}" update="@form" style="margin:10px;background:#003b50;color:white" />
	   		<p:commandButton value="Logs" onclick="PF('dlg1').show()"/>
	   		<p:commandButton value="Save Configuration"  actionListener="#{placeHoldersView.save}" 
	   			oncomplete="PF('dlg0').hide()"
	   			onclick="PF('dlg0').show()" update="growl" style="margin:10px;background:#003b50;color:white" />
	   		<p:commandButton value="Delete" style="margin:10px;background:red;color:white" 
	   			update="growl,@form" immediate="true"
	   			actionListener="#{placeHoldersView.deleteProject}"/>
   		</div>
   		
   		<p:poll interval="4" listener="#{placeHoldersView.refreshStatusProject}" update="syncstatus,healthstatus"/>
   		
	 			<h:panelGrid columns="2">
	 				<h:outputText value="My projects :"/>
	 				 <p:selectOneMenu  value="#{placeHoldersView.selectedProjectId}"
	 				 	 onchange="PF('dlg0').show()">
	 				 	 	<f:selectItem itemLabel="Select One" itemValue=""/>
	                  	<f:selectItems value="#{placeHoldersView.myProjects}" var="project" itemLabel="#{project}" itemValue="#{project}"/>
	                  	<p:ajax  oncomplete="PF('dlg0').hide()"  event="change" update="tabviewenv,giturl,growl,syncstatus,healthstatus,tableResources" listener="#{placeHoldersView.onSelectedProject(placeHoldersView.selectedProjectId)}" />
	                  	
	 				 </p:selectOneMenu>
	 				 <h:outputText value="Git url"/>
	 				 <h:outputText id="giturl" value="#{placeHoldersView.selectedProject.gitUrl}"/>
	 				 
	 				 <h:outputText value="Sync"/>
	 				 <h:panelGroup>
	 				 	<h:outputText id="syncstatus" value="#{placeHoldersView.appStatus.sync}"/>
	 				 	<p:commandButton value="Details"  					   			
					   			onclick="PF('dlgStatus').show()" style="margin:10px;background:#003b50;color:white" />
	 				 </h:panelGroup>
	 				 <h:outputText value="Health"/>
	 				 <h:outputText id="healthstatus" value="#{placeHoldersView.appStatus.health}"/>
	   			</h:panelGrid>
	   			
   			
   			
		   			<p:tabView value="#{placeHoldersView.selectedProject.environments}" var="env" id="tabviewenv" >
					    	<p:tab title="#{env.environment}" >
					    			<h:panelGrid columns="2" rendered="#{!env.dev}">
					    				<p:outputLabel value="Release (mandatory) : "/>
					    				 <p:selectOneMenu id="releaseTag" value="#{env.releaseTag}">
					    				 	 <f:selectItem itemLabel="Select One" itemValue=""/>
					    				 	 <f:selectItems value="#{placeHoldersView.tags}"/>
					    				 </p:selectOneMenu>
					    			</h:panelGrid>
					    	
					    			<div style="position:relative;margin:auto;text-align:center;">	
					    				<p:commandButton value="Apply And Deploy Project" 
					    					oncomplete="PF('dlg0').hide()"
	   										onclick="PF('dlg0').show()"
					    				 actionListener="#{placeHoldersView.synchronise(env.projectId)}" update="growl" style="margin:10px;background:#003b50;color:white" />
			   		
			   							<p:commandButton value="UnDeploy Project"  actionListener="#{placeHoldersView.refresh}" update="@form" style="margin:10px;background:#003b50;color:white" />
			   		
			   							<p:commandButton value="Rollback"  actionListener="#{placeHoldersView.refresh}" update="@form" style="margin:10px;background:#003b50;color:white" />
			   							
			   							<p:commandButton value="Promote >>>>"  actionListener="#{placeHoldersView.promote(env)}" update="@form" style="margin:10px;background:#a85032;color:white" />
			   						</div>
					    			<b>Clear Values :</b>
					    			<p:dataTable value="#{env.clearPlaceholders}"  var="entry"  widgetVar="placeHolderTable" id="configmaptable">
					    				<p:column  headerText="Env">	
									        		<h:outputText value="#{entry.placeHolderId.environment}"/>
										</p:column>	
					    				<p:column  headerText="Key">	
									        		<h:outputText value="#{entry.placeHolderId.key}"/>
										</p:column>		
										<p:column  headerText="Value" >	
									        		<p:inputText value="#{entry.value}" style="width:600px;" id="iptxt_placeholderValue"/>
										</p:column>		
										<p:column  headerText="">	
									        		<p:commandButton value="Delete" actionListener="#{placeHoldersView.deletePlaceHolder(entry,env)}" update="@form,growl"  rendered="#{!entry.version}"/>
									        		<p:commandButton value="Replace by : " rendered="#{entry.version}"/> 
									        		<p:selectOneMenu rendered="#{entry.version}" value="#{entry.value}">
									        			 <f:selectItem itemLabel="Select One" itemValue=""/>
									        			 <f:selectItems value="#{placeHoldersView.versions}"/>
									        			 <p:ajax  event="change" update="iptxt_placeholderValue"/>
									        		</p:selectOneMenu>									        		
										</p:column>		
										
					    			</p:dataTable>
					    			<br/>
					    			<b>Encrypted Values :</b>
					    			<p:dataTable value="#{env.secretsPlaceholders}"  var="entry"  widgetVar="placeHolderTable" id="secretstable">
					    				<p:column  headerText="Env">	
									        		<h:outputText value="#{entry.placeHolderId.environment}"/>
										</p:column>
					    				<p:column  headerText="Key">	
									        		<h:outputText value="#{entry.placeHolderId.key}" />
										</p:column>		
										<p:column  headerText="Value">	
									        		<p:password  value="#{entry.value}" toggleMask="true" redisplay="true" style="width:400px;"/>
										</p:column>		
										<p:column  headerText="">	
									        		<p:commandButton value="Delete" actionListener="#{placeHoldersView.deletePlaceHolder(entry,env)}" update="@form,growl" />									        		
										</p:column>
																	
					    			</p:dataTable>
					    			<br/>
					    			<b>New placeHolders detected :</b>
					    			<p:dataTable value="#{env.newPlaceholders}"  var="entry"  widgetVar="placeHolderTable">
					    				<p:column  headerText="Key">	
									        		<h:outputText value="#{entry.placeHolderId.key}" />
										</p:column>		
										<p:column  headerText="Action">	
									        	
									        		<p:commandButton value="Add as Clear value"  
									        			actionListener="#{placeHoldersView.addNewPlaceHolder(env,entry,false)}"
									        			update="@form" style="margin:10px;background:#003b50;color:white" />
			   										
			   										<p:commandButton value="Add as Secret value"  
			   											actionListener="#{placeHoldersView.addNewPlaceHolder(env,entry,true)}"
			   											update="@form" style="margin:10px;background:#003b50;color:white" />
									        	
										</p:column>									
					    			</p:dataTable>
					    	</p:tab>
					</p:tabView>
							
				<p:dialog header="Resources" widgetVar="dlgStatus" minHeight="500" width="1400" showEffect="fade"  id="dialogresources">
		
					<h:panelGrid columns="2">
						<h:outputLabel value="Reconcile At "/>
						<h:outputText id="fieldReconcileAt" value="#{placeHoldersView.appStatus.reconcileAt}"/>
					</h:panelGrid>
					<p:dataTable value="#{placeHoldersView.appStatus.argoResources}"  var="res" id="tableResources">
					
						<p:column  headerText="Version">	
							<h:outputText value="#{res.group}/#{res.version}"/>
						</p:column>
						<p:column  headerText="Kind">	
							<h:outputText value="#{res.kind}"/>
						</p:column>
						<p:column  headerText="Name">	
							<h:outputText value="#{res.name}"/>
						</p:column>
						<p:column  headerText="Status">	
							<h:outputText value="#{res.status}"/>
						</p:column>
						<p:column  headerText="HookPhase">	
							<h:outputText value="#{res.hookPhase}"/>
						</p:column>
						<p:column  headerText="SyncPhase">	
							<h:outputText value="#{res.syncPhase}"/>
						</p:column>
						<p:column  headerText="message">	
							<h:outputText value="#{res.message}"/>
						</p:column>
					
					</p:dataTable>						
					<p:poll interval="4"  update="tableResources,fieldReconcileAt"/>
			</p:dialog>
    	</h:form>
	</p:panel>
	

	
	<p:dialog header="Logs" widgetVar="dlg1" minHeight="500" width="1400" showEffect="fade">
		<h:form>
			<h:outputText escape="false"  id="txt_count" value="#{pollView.listLogs}"/>									
			<p:poll interval="1" listener="#{pollView.increment}" update="txt_count"/>
		</h:form>	
	</p:dialog>
 
 	<p:dialog  widgetVar="dlg0"  showEffect="fade">
		<h:form>
			<p:graphicImage name="loader_seq.gif"  style="background: transparent;"/>
		</h:form>	
	</p:dialog>
	
	
 
</h:body>
</html>
